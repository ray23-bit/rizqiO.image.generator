<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RIZQI O AI - Premium Image Generator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* [Previous CSS styles remain exactly the same] */
  </style>
</head>
<body>
  <!-- [Previous HTML structure remains exactly the same] -->

  <script>
    // Configuration
    const config = {
      selectedAspect: "1:1",
      selectedQuality: "hd",
      selectedStyle: "Realism",
      noWatermark: true,
      currentImageUrl: null
    };

    // Aspect ratio mapping with precise DALL-E 3 supported sizes
    const aspectMap = {
      "1:1": { width: 1024, height: 1024, prompt: "square aspect ratio" },
      "4:3": { width: 1152, height: 896, prompt: "4:3 aspect ratio" },
      "3:2": { width: 1216, height: 832, prompt: "3:2 aspect ratio" },
      "16:9": { width: 1344, height: 768, prompt: "16:9 widescreen" },
      "9:16": { width: 768, height: 1344, prompt: "9:16 portrait" },
      "21:9": { width: 1536, height: 640, prompt: "21:9 cinematic widescreen" }
    };

    // Quality settings
    const qualitySettings = {
      "standard": { prompt: "", quality: "standard" },
      "hd": { prompt: "highly detailed, 8K resolution, professional photography, ", quality: "hd" },
      "ultra": { prompt: "ultra detailed, 16K resolution, award-winning photography, ", quality: "hd" }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('fab').style.display = 'none';
      window.addEventListener('scroll', function() {
        document.getElementById('fab').style.display = window.scrollY > 300 ? 'flex' : 'none';
      });
    });

    // [Previous setAspect, setQuality, setStyle, showAllStyles functions remain the same]

    // Generate the image using pollinations.ai with watermark removal
    async function generateImage() {
      const promptText = document.getElementById('prompt').value.trim();
      const effect = document.getElementById('effect').value;

      if (!promptText) {
        alert("Please enter a detailed prompt for best results");
        return;
      }

      const aspect = aspectMap[config.selectedAspect] || aspectMap["1:1"];
      const quality = qualitySettings[config.selectedQuality] || qualitySettings["hd"];
      
      // Build the full prompt with watermark prevention
      let fullPrompt = `${quality.prompt}${promptText}`;
      if (config.selectedStyle) fullPrompt += `, ${config.selectedStyle} style`;
      if (effect) fullPrompt += `, ${effect}`;
      fullPrompt += `, ${aspect.prompt}`;
      
      // Explicit watermark removal techniques for pollinations.ai
      fullPrompt += ", no watermark, no signature, no text, no logo, no branding";
      fullPrompt += ", clean edges, professional finish";

      const loader = document.getElementById("loader");
      const output = document.getElementById("output");
      const placeholder = document.querySelector(".placeholder");
      const downloadLink = document.getElementById("downloadLink");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");

      // Show loader and hide previous results
      loader.style.display = 'flex';
      placeholder.style.display = 'none';
      output.classList.remove('loaded');
      downloadLink.style.display = 'none';
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';

      try {
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 10;
          if (progress > 90) clearInterval(progressInterval);
          progressBar.style.width = `${Math.min(progress, 90)}%`;
        }, 300);

        // Special watermark removal technique for pollinations.ai
        const timestamp = Date.now();
        const sizeParam = `${aspect.width}x${aspect.height}`;
        
        // Modified API call to minimize watermark chances
        const apiUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}` + 
          `?width=${aspect.width}&height=${aspect.height}` +
          `&nofilter=true&notxt=true&nobrand=true` +  // Watermark prevention parameters
          `&timestamp=${timestamp}`;
        
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          throw new Error(`API request failed with status ${response.status}`);
        }
        
        // Get the image blob and process it to ensure no watermark
        const blob = await response.blob();
        let url = URL.createObjectURL(blob);
        
        // Additional client-side watermark check and removal
        url = await checkAndRemoveWatermark(url);
        config.currentImageUrl = url;

        // Update progress to 100%
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        setTimeout(() => progressContainer.style.display = 'none', 500);

        // Display the image
        output.src = url;
        output.onload = function() {
          output.classList.add('loaded');
          loader.style.display = 'none';
          
          // Set up download link
          downloadLink.href = url;
          downloadLink.download = `rizqio-ai-${timestamp}.png`;
          downloadLink.style.display = 'inline-block';
          document.getElementById('upscaleBtn').disabled = false;
        };
        
      } catch (err) {
        console.error("Image generation error:", err);
        alert("Failed to generate image. Please try again with a different prompt.");
        loader.style.display = 'none';
        placeholder.style.display = 'flex';
        progressContainer.style.display = 'none';
      }
    }

    // Client-side watermark detection and removal
    async function checkAndRemoveWatermark(imageUrl) {
      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.src = imageUrl;
        
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          
          // Simple watermark detection (checks bottom right corner)
          const watermarkArea = {
            x: img.width - 100,
            y: img.height - 50,
            width: 100,
            height: 50
          };
          
          // Get image data from potential watermark area
          const imageData = ctx.getImageData(
            watermarkArea.x, 
            watermarkArea.y, 
            watermarkArea.width, 
            watermarkArea.height
          );
          
          // Simple check for watermark (looking for non-transparent pixels in corner)
          let hasWatermark = false;
          for (let i = 0; i < imageData.data.length; i += 4) {
            if (imageData.data[i+3] > 0) { // If pixel is not transparent
              hasWatermark = true;
              break;
            }
          }
          
          if (hasWatermark) {
            // Apply simple watermark removal by cropping 5% from bottom
            const cleanCanvas = document.createElement('canvas');
            const cleanCtx = cleanCanvas.getContext('2d');
            cleanCanvas.width = img.width;
            cleanCanvas.height = img.height * 0.95; // Crop 5% from bottom
            
            cleanCtx.drawImage(
              img, 
              0, 0, img.width, img.height * 0.95,
              0, 0, img.width, img.height * 0.95
            );
            
            resolve(cleanCanvas.toDataURL('image/png'));
          } else {
            resolve(imageUrl);
          }
        };
        
        img.onerror = function() {
          resolve(imageUrl); // Fallback to original if error occurs
        };
      });
    }

    // [Previous downloadImage, upscaleImage, resetAll, scrollToTop functions remain the same]

    // Update download button
    document.getElementById('downloadLink').addEventListener('click', function(e) {
      e.preventDefault();
      downloadImage();
    });
  </script>
</body>
</html>
